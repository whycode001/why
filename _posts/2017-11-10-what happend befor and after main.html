---
layout: page
title: main函数的前世今生
---
<h2>{{ page.title }}</h2>
<p>对于c和c++开发来说，一个程序的执行是必须包含一个main函数。但是对一些解释性的脚本语言比如python，shell是没这个要求的，在文件里写入代码直接通过命令就可以执行。那么在c语言下，main函数在整个程序执行之中是起到什么作用那？</p>
<p>
如果你仅仅想了解main函数的作用，那么你只看下面这一句话就好了：
<B>main函数提供了一个标识，告诉操作系统创建进程开始执行你开发程序的时候从哪里开始执行你的程序。</B>如果想更多了解一下main函数的存在逻辑、执行原理，那么可以继续阅读下面内容。
</p>
<p>对于main函数来说，就像刚才提到的“它是用户开发程序面向操作系统提供的一个入口”。在c标准中，main函数提供了俩种形式，一种是不接受任何参数的方式，一种是通过argc标识参数个数，argv这样一个指针的指针来传递参数内容：
<pre>
int main();
int main(int argc, char **argv);
</pre>
</p>

<p>回到最开始的问题，为何c语言里必须有main函数？</br>
这里就牵涉到编译性语言中的编译和链接相关内容。对于C语言这种编译性的语言来说，最终的可执行文件可能是通过很多个.c文件编译成很多个.o，最后通过链接生成的一个可执行文件。对于每个.C中可能都会有很多个函数栈，那么在执行的过程中如何决定哪个函数被首先执行？在这种情况下，约定俗称后来也成为一种标准的就是规定main函数作为最先执行的函数。编译器和链接器也对main函数特殊对待并相应进行特殊处理。<br/>

</p>

<p>
那这里再问一下，main函数真的必须有吗？<br/>
答案是 不必须。上面提到main函数作用是为了告知哪个函数被首先执行。如果我们自定义这样一个函数my_main，并想办法告知链接器和运行时函数让它把my_main当作入口函数而不是main，main函数就不是必须的了。
</p>

<p>
对于为何必须有个main函数，或者更严格的说为何必须有个入口函数，这个就牵涉到可执行文件在linux下被调用的具体过程了。附录里的第一个链接详细讲述了程序在执行中的调用过程。因为文章是英文的，为了方便阅读在这里对主要内容做一个介绍，有兴趣了解的可以点开链接详细阅读。
</p>

<p>
当一个程序被执行的时候，整个流程包含了<B>main函数执行前、main函数、main函数执行后</B>三个阶段。<br/>
核心调用过程如下；
<br/>
<img src = "{{ site.baseurl }}/img/posts/callgraph.png">
执行前主要是由linux装载器来完成，包括申请运行时资源、加载可执行文件到代码段、链接程序使用的动态库。当加载可执行文件到代码段之后，就可以根据ELF的内容拿到程序的入口地址，然后就进入下一步。
</p>

<p>在执行上一布的程序装载工作之后，就开始进入_start方法。该方法会执行一定的程序执行环境的初始化工作，初始化栈帧内容，用户传递的参数，准备下一步函数的必须参数。当_start初始化完，就继续调用下一个函数__libc_start_main。这时候会再次进行初始化工作，包括程序里全局变量、静态变量等。
</p>

<p>
当main函数执行结束之后，无论是调用return还是exit，程序的执行权都会从你的main函数退出交回到操作系统。这个时候操作系统会执行程序执行现场的回收工作，包括静态资源的回收，栈帧的回收等，在C++中因为在栈上的对象也会被回收，所以在main函数执行结束还会调用对象的析构函数。
</p>

<p>
至此你的可执行文件才真的结束。
</p>

<p>
<B>附录：</B>
<br/>
1：<a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html", target="_blank">linux下程序启动介绍</a>
</p>
<p>{{ page.date | date_to_string }}</p>
